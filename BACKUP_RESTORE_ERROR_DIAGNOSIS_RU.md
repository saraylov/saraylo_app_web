# Диагностика и устранение ошибки 404 при восстановлении бэкапа

## Проблема
При попытке восстановления данных из бэкапа в приложении Saraylo Admin Electron возникает ошибка "Request failed with status code 404". При тестировании API через Node.js скрипт получаем HTML страницу ошибки вместо JSON ответа.

## Диагностика

### 1. Проверка структуры файлов
✅ Структура директорий корректна:
```
src/routes/api/v1/backups/
├── +server.ts              # Основной endpoint для списка/создания
└── [id]/
    └── +server.ts          # Endpoint для конкретного бэкапа
```

### 2. Проверка импортов
✅ Все необходимые импорты присутствуют:
- `backupStore` из `'$lib/api/services/backupService'`
- Все необходимые функции из `'$lib/api/auth'` и `'$lib/api/utils'`

### 3. Проверка функциональности других endpoint'ов
✅ Работают корректно:
- Аутентификация (`/api/v1/auth/login`)
- Получение списка бэкапов (`/api/v1/backups`)
- Создание бэкапа (`/api/v1/backups` POST)
- Удаление бэкапа (`/api/v1/backups/{id}` DELETE)

❌ Не работает:
- Восстановление из бэкапа (`/api/v1/backups/{id}/restore` POST)

### 4. Анализ ошибки
Ошибка "Unexpected token '<'" указывает на то, что сервер возвращает HTML страницу (вероятно, страницу ошибки 404) вместо JSON ответа.

## Возможные причины

### 1. Проблемы с маршрутизацией SvelteKit
Маршрут `[id]/+server.ts` может не распознаваться корректно из-за:
- Конфликта с другими маршрутами
- Проблем с конфигурацией Vite/SvelteKit
- Кэширования маршрутов

### 2. Проблемы с методом POST
Может быть конфликт между методами в одном файле или неправильная обработка маршрута.

## Решения для проверки

### Решение 1: Создание отдельного endpoint для восстановления
Создать отдельный маршрут `/api/v1/backups/[id]/restore/+server.ts` вместо использования метода POST в `[id]/+server.ts`.

### Решение 2: Проверка конфигурации SvelteKit
Убедиться, что в `svelte.config.js` и `vite.config.ts` нет ограничений на вложенные маршруты.

### Решение 3: Дебаггинг маршрутов
Добавить логирование в hook'и SvelteKit для отслеживания маршрутов.

## Рекомендованный подход

Рекомендую реализовать **Решение 1** - создать отдельный endpoint для восстановления, так как это:
- Следует лучшим практикам REST API
- Упрощает отладку и тестирование
- Позволяет лучше контролировать доступ к различным операциям

## План действий

1. Создать отдельный файл `src/routes/api/v1/backups/[id]/restore/+server.ts`
2. Перенести логику восстановления в новый endpoint
3. Протестировать все функции API
4. Обновить клиентскую часть при необходимости
5. Задокументировать изменения

## Текущий статус
- ✅ Основная архитектура исправлена
- ✅ Централизованное хранилище данных реализовано
- ✅ Все CRUD операции работают корректно
- ✅ Реализовано настоящее восстановление данных (не эмуляция)
- ✅ Создан сервис реального восстановления данных
- ✅ Обновлен API endpoint восстановления
- ✅ Улучшен пользовательский интерфейс с детальной информацией

## Что было реализовано

### 1. Сервис реального восстановления данных
Создан файл `src/lib/api/services/dataRestoreService.ts` который:
- Получает текущее состояние всех данных
- Удаляет текущие данные указанного типа
- Восстанавливает данные из бэкапа
- Поддерживает восстановление продуктов, членов команды и навигации
- Обрабатывает ошибки и частичное восстановление

### 2. Обновленный API endpoint
Модифицирован `src/routes/api/v1/backups/[id]/restore/+server.ts` для:
- Использования реального сервиса восстановления
- Возвращения детальной информации о восстановленных данных
- Обработки ошибок восстановления

### 3. Улучшенный пользовательский интерфейс
Обновлен `saraylo-admin-electron/js/backupUI.js` для:
- Отображения детальной информации о восстановленных элементах
- Показа количества восстановленных продуктов, членов команды и навигации
- Лучшей обратной связи пользователю

### 4. Тестирование
Создан тестовый скрипт `test-real-data-restore.js` для проверки:
- Реального восстановления данных
- Корректности количества восстановленных элементов
- Обработки ошибок